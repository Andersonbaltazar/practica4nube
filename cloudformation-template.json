{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Task App - EC2 Ubuntu 20.04 + RDS PostgreSQL",

  "Parameters": {
    "KeyName": {
      "Description": "Nombre del KeyPair existente",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "VpcId": {
      "Description": "ID de la VPC",
      "Type": "AWS::EC2::VPC::Id"
    },
    "SubnetId": {
      "Description": "ID de la Subnet",
      "Type": "AWS::EC2::Subnet::Id"
    },
    "LatestAmiId": {
      "Description": "Última AMI Ubuntu 20.04",
      "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
      "Default": "/aws/service/canonical/ubuntu/server/focal/stable/current/amd64/hvm/ebs-gp2/ami-id"
    }
  },

  "Resources": {
    "AppSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "SG para Task App",
        "VpcId": { "Ref": "VpcId" },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 3000,
            "ToPort": 3000,
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },

    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "SG para RDS",
        "VpcId": { "Ref": "VpcId" },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 5432,
            "ToPort": 5432,
            "SourceSecurityGroupId": { "Ref": "AppSecurityGroup" }
          }
        ]
      }
    },

    "TaskDatabase": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBInstanceIdentifier": "task-app-db",
        "Engine": "postgres",
        "EngineVersion": "12.15",
        "DBInstanceClass": "db.t3.micro",
        "AllocatedStorage": "20",
        "StorageType": "gp2",
        "MasterUsername": "postgres",
        "MasterUserPassword": "TaskApp2024!",
        "VPCSecurityGroups": [{ "Ref": "DBSecurityGroup" }],
        "BackupRetentionPeriod": 7,
        "MultiAZ": false,
        "PubliclyAccessible": false,
        "Tags": [
          { "Key": "Name", "Value": "task-app-db" }
        ]
      }
    },

    "TaskInstance": {
      "Type": "AWS::EC2::Instance",
      "DependsOn": "TaskDatabase",
      "Properties": {
        "InstanceType": "t2.micro",
        "KeyName": { "Ref": "KeyName" },
        "ImageId": { "Ref": "LatestAmiId" },
        "SubnetId": { "Ref": "SubnetId" },
        "SecurityGroupIds": [{ "Ref": "AppSecurityGroup" }],
        "Tags": [
          { "Key": "Name", "Value": "task-app-server" }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Sub": "#!/bin/bash\napt-get update\napt-get install -y docker.io docker-compose git nodejs npm nginx\nsystemctl start docker\ncd /home/ubuntu\nsudo -u ubuntu git clone https://github.com/Andersonbaltazar/practica4nube.git app\ncd app\ncat > .env << 'EOF'\nNODE_ENV=production\nPORT=3000\nDB_USER=postgres\nDB_PASSWORD=TaskApp2024!\nDB_HOST=${TaskDatabase.Endpoint.Address}\nDB_PORT=5432\nDB_NAME=task_app\nSESSION_SECRET=secret123\nEOF\nsudo -u ubuntu npm install\ndocker-compose up -d\ncat > /etc/nginx/sites-available/default << 'NGINX'\nserver {\n  listen 80;\n  location / {\n    proxy_pass http://localhost:3000;\n    proxy_set_header Host $host;\n  }\n}\nNGINX\nsystemctl restart nginx"
          }
        }
      }
    }
  },

  "Outputs": {
    "InstanceId": {
      "Description": "ID de la instancia",
      "Value": { "Ref": "TaskInstance" }
    },
    "PublicIP": {
      "Description": "IP pública",
      "Value": { "Fn::GetAtt": ["TaskInstance", "PublicIp"] }
    },
    "DatabaseEndpoint": {
      "Description": "RDS endpoint",
      "Value": { "Fn::GetAtt": ["TaskDatabase", "Endpoint.Address"] }
    },
    "AppURL": {
      "Description": "URL de la aplicación",
      "Value": { "Fn::Sub": "http://${TaskInstance.PublicIp}" }
    }
  }
}
