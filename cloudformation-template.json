{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Task App - EC2 Ubuntu 20.04 con PostgreSQL en Docker",
  "Parameters": {
    "KeyName": {
      "Description": "EC2 KeyPair Name",
      "Type": "AWS::EC2::KeyPair::KeyName"
    }
  },
  "Resources": {
    "AppSG": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Task App Security Group",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": 22, "ToPort": 22, "CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp", "FromPort": 80, "ToPort": 80, "CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp", "FromPort": 3000, "ToPort": 3000, "CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp", "FromPort": 5432, "ToPort": 5432, "CidrIp": "127.0.0.1/32"}
        ]
      }
    },
    "TaskInstance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType": "t2.micro",
        "KeyName": {"Ref": "KeyName"},
        "ImageId": {"Fn::Sub": "{{resolve:ssm:/aws/service/canonical/ubuntu/server/focal/stable/current/amd64/hvm/ebs-gp2/ami-id}}"},
        "SecurityGroupIds": [{"Ref": "AppSG"}],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": 30,
              "VolumeType": "gp2",
              "DeleteOnTermination": true
            }
          }
        ],
        "UserData": {
          "Fn::Base64": "#!/bin/bash\nset -e\napt-get update\napt-get install -y docker.io docker-compose git curl\nsystemctl start docker\nsystemctl enable docker\nusermod -aG docker ubuntu\ncd /home/ubuntu\nsudo -u ubuntu git clone https://github.com/Andersonbaltazar/practica4nube.git app\ncd app\ncat > .env << 'EOFENV'\nNODE_ENV=production\nPORT=3000\nDB_USER=postgres\nDB_PASSWORD=TaskApp2024secure\nDB_HOST=localhost\nDB_PORT=5432\nDB_NAME=task_app\nSESSION_SECRET=supersecret2024\nEOFENV\nchown ubuntu:ubuntu .env\nsudo -u ubuntu docker-compose up -d\nsleep 10"
        },
        "Tags": [
          {"Key": "Name", "Value": "task-app-server"}
        ]
      }
    }
  },
  "Outputs": {
    "PublicIP": {
      "Description": "Application Access URL",
      "Value": {"Fn::Sub": "http://${TaskInstance.PublicIp}:3000"}
    },
    "SSHCommand": {
      "Description": "SSH Access Command",
      "Value": {"Fn::Sub": "ssh -i lab07.pem ubuntu@${TaskInstance.PublicIp}"}
    }
  }
}
